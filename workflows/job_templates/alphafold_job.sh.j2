#!/bin/bash
#SBATCH --job-name=af3_{{ protein_name }}
#SBATCH --output={{ logs_dir }}/%x_%j.out
#SBATCH --error={{ logs_dir }}/%x_%j.err
#SBATCH --partition={{ partition }}
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --cpus-per-task={{ cpus }}
#SBATCH --gres=gpu:h200:1
#SBATCH --mem={{ memory }}
#SBATCH --time=02:00:00
{% if email %}
#SBATCH --mail-user={{ email }}
#SBATCH --mail-type=ALL
{% endif %}

set -euo pipefail

# ‚îÄ‚îÄ AlphaFold 3 container and resource paths ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
export AF3_RESOURCES_DIR=/shared/container_repository/AlphaFold
export AF3_IMAGE=${AF3_RESOURCES_DIR}/alphafold3.sif
export DATA_PATH=/shared/container_repository/AlphaFold/database
export MODEL_PATH=/projects/SimBioSys/share/software/AF3/models
export TEMPLATE_DATE=2025-07-15        # fallback if config omits it

# Ensure JAX inside container respects GPU memory fraction
export SINGULARITYENV_XLA_CLIENT_MEM_FRACTION=0.95
export APPTAINERENV_XLA_CLIENT_MEM_FRACTION=0.95
export SINGULARITYENV_XLA_FLAGS="--xla_disable_hlo_passes=custom-kernel-fusion-rewriter"
export APPTAINERENV_XLA_FLAGS="--xla_disable_hlo_passes=custom-kernel-fusion-rewriter"

# ‚îÄ‚îÄ Configuration file supplied by the user ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
CONFIG_FILE="{{ config_file }}"
PROTEIN_NAME="{{ protein_name }}"

echo "Starting AlphaFold 3 for ${PROTEIN_NAME}"
echo "  Config: ${CONFIG_FILE}"

# jq is required; abort with a clear message if missing
command -v jq >/dev/null 2>&1 || { echo >&2 "‚ùå jq not found ‚Äî install or module-load it."; exit 1; }

# ‚îÄ‚îÄ Pull fields we still use from the JSON config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
SEQUENCE_FILE=$(jq -r '.sequence_file'             "${CONFIG_FILE}")
MODEL_SEEDS=$(jq -r '.model_seeds | join(",")'      "${CONFIG_FILE}")
OUTPUT_DIR=$(jq -r '.output_dir'                    "${CONFIG_FILE}")
MAX_TEMPLATE_DATE=$(jq -r '.max_template_date // ""' "${CONFIG_FILE}")
NUM_RECYCLE=$(jq -r '.num_recycle // 10'            "${CONFIG_FILE}")  # default 10 cycles

# Optional ligand section
LIGAND_ID=$(jq -r '.ligand.id // empty' "${CONFIG_FILE}")
if [ -n "${LIGAND_ID}" ]; then
  LIGAND_CCD_CODES=$(jq -r \
    '.ligand.ccd_codes // [] | map("\""+.+"\"") | join(",")' "${CONFIG_FILE}")
fi

mkdir -p "${OUTPUT_DIR}"

# ‚îÄ‚îÄ Build a valid AlphaFold 3 input JSON ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
FASTA_CONTENT=$(cat "${SEQUENCE_FILE}")
SEQUENCE=$(echo "${FASTA_CONTENT}" | grep -v "^>" | tr -d '\n')

# Clean header ‚Üí uppercase letters only; fall back to PROTEIN_NAME
SEQ_ID_RAW=$(echo "${FASTA_CONTENT}" | grep "^>" | head -n1 | sed 's/^>//')
SEQUENCE_ID=$(echo "${SEQ_ID_RAW}" | tr '[:lower:]' '[:upper:]' | tr -cd 'A-Z')
if [ -z "${SEQUENCE_ID}" ]; then
  SEQUENCE_ID=$(echo "${PROTEIN_NAME}" | tr '[:lower:]' '[:upper:]' | tr -cd 'A-Z')
fi

AF3_INPUT_JSON="${OUTPUT_DIR}/${PROTEIN_NAME}_af3_input.json"
{
  echo '{'
  echo '  "name": "'"${PROTEIN_NAME}"'",'
  echo '  "modelSeeds": ['"${MODEL_SEEDS}"'],'
  echo '  "sequences": ['
  echo '    { "protein": { "id": "'"${SEQUENCE_ID}"'", "sequence": "'"${SEQUENCE}"'" } }'
  if [ -n "${LIGAND_ID:-}" ]; then
    echo '    ,{ "ligand": { "id": "'"${LIGAND_ID}"'", "ccdCodes": ['"${LIGAND_CCD_CODES}"'] } }'
  fi
  echo '  ],'
  echo '  "dialect": "alphafold3",'
  echo '  "version": 1'
  echo '}'
} > "${AF3_INPUT_JSON}"

echo "Generated AF3 JSON:"
cat "${AF3_INPUT_JSON}"

# ‚îÄ‚îÄ Launch AlphaFold 3 inside the container ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
singularity exec --nv --cleanenv \
  --bind /projects:/work \
  --bind /scratch:/scratch \
  --bind /shared:/shared \
  --bind "${DATA_PATH}":/data \
  --bind "${MODEL_PATH}":/models \
  --bind /lib64/libcuda.so.1:/usr/local/nvidia/lib64/libcuda.so.1 \
  --bind /lib64/libnvidia-ml.so.1:/usr/local/nvidia/lib64/libnvidia-ml.so.1 \
  "${AF3_IMAGE}" \
  python /app/alphafold/run_alphafold.py \
    --json_path        "${AF3_INPUT_JSON}" \
    --output_dir       "${OUTPUT_DIR}/$(basename "${AF3_INPUT_JSON}" .json)" \
    --logtostderr \
    --db_dir           "/data" \
    --model_dir        "/models" \
    --max_template_date "${MAX_TEMPLATE_DATE:-${TEMPLATE_DATE}}" \
    --num_recycles     "${NUM_RECYCLE}" \
    --flash_attention_implementation xla

echo "AlphaFold 3 prediction completed."

# ‚îÄ‚îÄ Copy the best-ranked model to a predictable filename ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# AlphaFold3 outputs CIF files, not PDB files. Look for the main model.cif file
# The structure is typically: OUTPUT_DIR/PROTEIN_af3_input/protein_name_lower/protein_name_lower_model.cif

# Find the actual output directory (may have timestamp suffix)
AF3_OUTPUT_BASE="${OUTPUT_DIR}/$(basename "${AF3_INPUT_JSON}" .json)"
PROTEIN_LOWER=$(echo "${PROTEIN_NAME}" | tr '[:upper:]' '[:lower:]')

# Look for the protein subdirectory (could be direct or timestamped)
if [ -d "${AF3_OUTPUT_BASE}/${PROTEIN_LOWER}" ]; then
    ACTUAL_OUTPUT_DIR="${AF3_OUTPUT_BASE}/${PROTEIN_LOWER}"
elif [ -d "${AF3_OUTPUT_BASE}/${PROTEIN_LOWER}_"* ]; then
    # Find the most recent timestamped directory
    ACTUAL_OUTPUT_DIR=$(ls -dt "${AF3_OUTPUT_BASE}/${PROTEIN_LOWER}_"* | head -n1)
else
    ACTUAL_OUTPUT_DIR="${AF3_OUTPUT_BASE}"
fi

echo "Looking for model in: ${ACTUAL_OUTPUT_DIR}"

# Look for the main model CIF file
BEST_MODEL="${ACTUAL_OUTPUT_DIR}/${PROTEIN_LOWER}_model.cif"

if [ -f "${BEST_MODEL}" ]; then
  cp "${BEST_MODEL}" "${OUTPUT_DIR}/${PROTEIN_NAME}_best_model.cif"
  echo "‚úÖ Best model saved ‚Üí ${OUTPUT_DIR}/${PROTEIN_NAME}_best_model.cif"
  
  # Also check for confidence scores
  SUMMARY_CONF="${ACTUAL_OUTPUT_DIR}/${PROTEIN_LOWER}_summary_confidences.json"
  if [ -f "${SUMMARY_CONF}" ]; then
    echo "üìä Confidence scores found:"
    jq -r '.ranking_score // "N/A" | "   Ranking Score: \(.)"' "${SUMMARY_CONF}"
    jq -r '.ptm // "N/A" | "   PTM Score: \(.)"' "${SUMMARY_CONF}"
  fi
else
  # Fallback: look for any CIF file in the output directory
  echo "‚ö†Ô∏è  Main model not found at expected location, searching for any CIF files..."
  CIF_FILES=$(find "${AF3_OUTPUT_BASE}" -name "*.cif" -type f 2>/dev/null | grep -v "TERMS_OF_USE")
  
  if [ -n "${CIF_FILES}" ]; then
    FIRST_CIF=$(echo "${CIF_FILES}" | head -n1)
    cp "${FIRST_CIF}" "${OUTPUT_DIR}/${PROTEIN_NAME}_best_model.cif"
    echo "‚úÖ Found and copied CIF file: ${FIRST_CIF}"
    echo "   ‚Üí Saved as: ${OUTPUT_DIR}/${PROTEIN_NAME}_best_model.cif"
  else
    echo "‚ùå No CIF model files found. Directory contents:"
    ls -la "${AF3_OUTPUT_BASE}/"
    if [ -d "${ACTUAL_OUTPUT_DIR}" ] && [ "${ACTUAL_OUTPUT_DIR}" != "${AF3_OUTPUT_BASE}" ]; then
      echo "Subdirectory contents:"
      ls -la "${ACTUAL_OUTPUT_DIR}/"
    fi
  fi
fi

echo "Job finished for ${PROTEIN_NAME}"

